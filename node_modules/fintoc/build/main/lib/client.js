"use strict";
var __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (receiver, state, kind, f) {
    if (kind === "a" && !f) throw new TypeError("Private accessor was defined without a getter");
    if (typeof state === "function" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError("Cannot read private member from an object whose class did not declare it");
    return kind === "m" ? f : kind === "a" ? f.call(receiver) : f ? f.value : state.get(receiver);
};
var __classPrivateFieldSet = (this && this.__classPrivateFieldSet) || function (receiver, state, value, kind, f) {
    if (kind === "m") throw new TypeError("Private method is not writable");
    if (kind === "a" && !f) throw new TypeError("Private accessor was defined without a setter");
    if (typeof state === "function" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError("Cannot write private member to an object whose class did not declare it");
    return (kind === "a" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var _a, _Client_client;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Client = void 0;
const crypto_1 = __importDefault(require("crypto"));
const axios_1 = __importDefault(require("axios"));
const jws_1 = require("./jws");
const paginator_1 = require("./paginator");
class Client {
    constructor(options) {
        const { baseUrl, apiKey, userAgent, params = {}, jwsPrivateKey, } = options;
        this.baseUrl = baseUrl;
        this.apiKey = apiKey;
        this.userAgent = userAgent;
        this.params = params || {};
        if (jwsPrivateKey) {
            this.jws = new jws_1.JWSSignature(jwsPrivateKey);
        }
    }
    get client() {
        if (__classPrivateFieldGet(_a, _a, "f", _Client_client) === undefined) {
            __classPrivateFieldSet(_a, _a, axios_1.default.create({
                baseURL: this.baseUrl,
                headers: this.staticHeaders,
                params: this.params,
            }), "f", _Client_client);
        }
        return __classPrivateFieldGet(_a, _a, "f", _Client_client);
    }
    get staticHeaders() {
        return { Authorization: this.apiKey, 'User-Agent': this.userAgent, 'Content-Type': 'application/json' };
    }
    async request(options) {
        const { path, json, paginated = false, method = 'get', params = {}, idempotencyKey, } = options;
        const url = `${this.baseUrl}${path}`;
        const allParams = { ...this.params, ...params };
        if (paginated) {
            return (0, paginator_1.paginate)({
                client: this.client,
                path: url,
                headers: this.staticHeaders,
                params: allParams,
            });
        }
        const rawBody = JSON.stringify(json);
        const headers = this.buildHeaders(method, rawBody, idempotencyKey);
        const response = await this.client.request({
            method, url, params: allParams, data: rawBody, headers,
        });
        return response.data;
    }
    extend(extension) {
        const { baseUrl, apiKey, userAgent, params, } = (extension || {});
        return new _a({
            baseUrl: baseUrl || this.baseUrl,
            apiKey: apiKey || this.apiKey,
            userAgent: userAgent || this.userAgent,
            params: params ? { ...this.params, ...params } : { ...this.params },
        });
    }
    buildHeaders(method, rawBody, idempotencyKey) {
        const headers = {
            ...this.staticHeaders,
            ...this.buildJWSHeaders(method, rawBody),
        };
        if (method === 'post') {
            headers['Idempotency-Key'] = idempotencyKey || crypto_1.default.randomUUID();
        }
        return headers;
    }
    buildJWSHeaders(method, rawBody) {
        if (this.jws && (method === 'post' || method === 'put' || method === 'patch')) {
            const signature = this.jws.generateHeader(rawBody);
            return { 'Fintoc-JWS-Signature': signature };
        }
        return {};
    }
}
exports.Client = Client;
_a = Client;
_Client_client = { value: void 0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsb0RBQTRCO0FBRTVCLGtEQUE2QztBQU03QywrQkFBcUM7QUFDckMsMkNBQXVDO0FBRXZDLE1BQWEsTUFBTTtJQVNqQixZQUFZLE9BQTRCO1FBQ3RDLE1BQU0sRUFDSixPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLEdBQUcsRUFBRSxFQUFFLGFBQWEsR0FDdkQsR0FBRyxPQUFPLENBQUM7UUFDWixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUMzQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFDM0IsSUFBSSxhQUFhLEVBQUUsQ0FBQztZQUNsQixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksa0JBQVksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM3QyxDQUFDO0lBQ0gsQ0FBQztJQUVELElBQVksTUFBTTtRQUNoQixJQUFJLHVCQUFBLEVBQU0sMEJBQVEsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUNqQyx1QkFBQSxFQUFNLE1BQVcsZUFBSyxDQUFDLE1BQU0sQ0FBQztnQkFDNUIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO2dCQUNyQixPQUFPLEVBQUUsSUFBSSxDQUFDLGFBQWE7Z0JBQzNCLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTthQUNwQixDQUFDLHNCQUFBLENBQUM7UUFDTCxDQUFDO1FBQ0QsT0FBTyx1QkFBQSxFQUFNLDBCQUFRLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQUksYUFBYTtRQUNmLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxZ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