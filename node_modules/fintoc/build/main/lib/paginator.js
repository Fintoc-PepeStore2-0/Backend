"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseLink = parseLink;
exports.parseLinkHeaders = parseLinkHeaders;
exports.request = request;
exports.paginate = paginate;
const constants_1 = require("./constants");
/**
 * Parse a link string and return an object with previous parsed links and the new one.
 *
 * @param object - Object containing already parsed links
 * @param link - String with the link header to parse
 * @returns Object that corresponds to the destructured `object` object and the parsed `link` string
 */
function parseLink(object, link) {
    const data = constants_1.LINK_HEADER_PATTERN.exec(link);
    if (data === null || data.groups === undefined) {
        return object;
    }
    const { groups } = data;
    return { ...object, [groups.rel]: groups.url };
}
function parseLinkHeaders(linkHeader) {
    if (linkHeader === null || linkHeader === undefined) {
        return linkHeader;
    }
    return linkHeader.split(',').reduce(parseLink, {});
}
async function request(options) {
    const { client, path, headers, params = {}, } = options;
    const response = await client.request({
        method: 'get', url: path, params: params || {}, headers,
    });
    const responseHeaders = parseLinkHeaders(response.headers.link);
    const next = responseHeaders && responseHeaders.next;
    const elements = response.data;
    return { next, elements };
}
async function* paginate(options) {
    const { client, path, headers, params = {}, } = options;
    let response = await request({
        client, path, headers, params,
    });
    /* eslint-disable no-await-in-loop */
    for (const element of response.elements) {
        yield element;
    }
    while (response.next) {
        response = await request({ client, path: response.next, headers });
        for (const element of response.elements) {
            yield element;
        }
    }
    /* eslint-enable no-await-in-loop */
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9wYWdpbmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFXQSw4QkFPQztBQVlELDRDQU9DO0FBRUQsMEJBV0M7QUFFRCw0QkFrQkM7QUFwRUQsMkNBQWtEO0FBRWxEOzs7Ozs7R0FNRztBQUNILFNBQWdCLFNBQVMsQ0FBQyxNQUE4QixFQUFFLElBQVk7SUFDcEUsTUFBTSxJQUFJLEdBQUcsK0JBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVDLElBQUksSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVMsRUFBRSxDQUFDO1FBQy9DLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLE9BQU8sRUFBRSxHQUFHLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDakQsQ0FBQztBQVlELFNBQWdCLGdCQUFnQixDQUM5QixVQUFxQztJQUVyQyxJQUFJLFVBQVUsS0FBSyxJQUFJLElBQUksVUFBVSxLQUFLLFNBQVMsRUFBRSxDQUFDO1FBQ3BELE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFDRCxPQUFPLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNyRCxDQUFDO0FBRU0sS0FBSyxVQUFVLE9BQU8sQ0FBQyxPQUEyQjtJQUN2RCxNQUFNLEVBQ0osTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxHQUFHLEVBQUUsR0FDbkMsR0FBRyxPQUFPLENBQUM7SUFDWixNQUFNLFFBQVEsR0FBRyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQTZCO1FBQ2hFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsTUFBTSxJQUFJLEVBQUUsRUFBRSxPQUFPO0tBQ3hELENBQUMsQ0FBQztJQUNILE1BQU0sZUFBZSxHQUFHLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEUsTUFBTSxJQUFJLEdBQUcsZUFBZSxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUM7SUFDckQsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztJQUMvQixPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDO0FBQzVCLENBQUM7QUFFTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUEyQjtJQUN6RCxNQUFNLEVBQ0osTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxHQUFHLEVBQUUsR0FDbkMsR0FBRyxPQUFPLENBQUM7SUFDWixJQUFJLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQztRQUMzQixNQUFNLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNO0tBQzlCLENBQUMsQ0FBQztJQUNILHFDQUFxQztJQUNyQyxLQUFLLE1BQU0sT0FBTyxJQUFJLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN4QyxNQUFNLE9BQU8sQ0FBQztJQUNoQixDQUFDO0lBQ0QsT0FBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckIsUUFBUSxHQUFHLE1BQU0sT0FBTyxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDbkUsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDeEMsTUFBTSxPQUFPLENBQUM7UUFDaEIsQ0FBQztJQUNILENBQUM7SUFDRCxvQ0FBb0M7QUFDdEMsQ0FBQyJ9