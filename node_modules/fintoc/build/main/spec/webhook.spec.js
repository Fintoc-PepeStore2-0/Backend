"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const ava_1 = __importDefault(require("ava"));
const errors_1 = require("../lib/errors");
const webhook_1 = require("../lib/webhook");
const testPayloadRaw = `{
  "id": "evt_2AaZeLCz0GjOW5zj",
  "type": "payment_intent.succeeded",
  "mode": "test",
  "created_at": "2025-04-05T21:57:31.834Z",
  "data": {
    "id": "pi_2vKOKniSGXRhXTKrJ67VXZxGCVt",
    "mode": "test",
    "amount": 1,
    "object": "payment_intent",
    "status": "succeeded",
    "currency": "MXN",
    "metadata": {},
    "created_at": "2025-04-05T21:57:17Z",
    "expires_at": null,
    "error_reason": null,
    "payment_type": "bank_transfer",
    "reference_id": null,
    "widget_token": null,
    "customer_email": null,
    "sender_account": {
      "type": "checking_account",
      "number": "501514890244223279",
      "holder_id": "mfiu593501oe4",
      "institution_id": "mx_stp"
    },
    "business_profile": null,
    "transaction_date": null,
    "recipient_account": {
      "type": "checking_account",
      "number": "646180357600000000",
      "holder_id": "fsm211008hz9",
      "institution_id": "mx_stp"
    },
    "payment_type_options": {}
  },
  "object": "event"
}`;
const testPayload = testPayloadRaw.replace(/\s+/g, '');
const testSecret = 'whsec_test_secret';
const testTimestamp = 1743890251;
const testHeader = `t=${testTimestamp},v1=11b98dd8f5500109246aa4d9875fad2e97d462560b012a5f50ff924411de0b0f`;
const getCurrentTimestamp = () => Math.floor(Date.now() / 1000);
(0, ava_1.default)('WebhookSignature.verifyHeader should succeed for valid signature and recent timestamp', (t) => {
    const largeTolerance = Math.abs(getCurrentTimestamp() - testTimestamp) + 100;
    t.notThrows(() => webhook_1.WebhookSignature.verifyHeader(testPayload, testHeader, testSecret, largeTolerance));
});
(0, ava_1.default)('WebhookSignature.verifyHeader should throw error for signature mismatch', (t) => {
    const badHeader = `t=${testTimestamp},v1=bad_signature`;
    const largeTolerance = Math.abs(getCurrentTimestamp() - testTimestamp) + 100;
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, badHeader, testSecret, largeTolerance);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.is(error === null || error === void 0 ? void 0 : error.message, 'Signature mismatch. The webhook signature is not valid.');
});
(0, ava_1.default)('WebhookSignature.verifyHeader should throw error for old timestamp', (t) => {
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, testHeader, testSecret);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.true(error === null || error === void 0 ? void 0 : error.message.startsWith('Timestamp outside the tolerance zone'));
});
(0, ava_1.default)('WebhookSignature.verifyHeader should throw for empty header string', (t) => {
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, '', testSecret);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.is(error === null || error === void 0 ? void 0 : error.message, 'Missing Fintoc-Signature header.');
});
(0, ava_1.default)('WebhookSignature.verifyHeader should throw for header with empty timestamp and signature values', (t) => {
    const header = 't=,v1=';
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, header, testSecret);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.is(error === null || error === void 0 ? void 0 : error.message, 'Unable to extract timestamp and signatures from header');
});
(0, ava_1.default)('WebhookSignature.verifyHeader should throw for header with non-numeric timestamp', (t) => {
    const header = 't=foo,v1=bar';
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, header, testSecret);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.is(error === null || error === void 0 ? void 0 : error.message, 'Unable to extract timestamp and signatures from header');
});
(0, ava_1.default)('WebhookSignature.verifyHeader should throw for header missing v1 part', (t) => {
    const header = `t=${testTimestamp}`;
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, header, testSecret);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.is(error === null || error === void 0 ? void 0 : error.message, 'Unable to extract timestamp and signatures from header');
});
(0, ava_1.default)('WebhookSignature.verifyHeader should throw for header missing t part', (t) => {
    const signature = '11b98dd8f5500109246aa4d9875fad2e97d462560b012a5f50ff924411de0b0f';
    const header = `v1=${signature}`;
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, header, testSecret);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.is(error === null || error === void 0 ? void 0 : error.message, 'Unable to extract timestamp and signatures from header');
});
(0, ava_1.default)('WebhookSignature.verifyHeader should throw error for missing secret', (t) => {
    const largeTolerance = Math.abs(getCurrentTimestamp() - testTimestamp) + 100;
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, testHeader, '', largeTolerance);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.is(error === null || error === void 0 ? void 0 : error.message, 'Webhook secret is required for verification.');
});
(0, ava_1.default)('WebhookSignature.verifyHeader should handle custom tolerance', (t) => {
    const error = t.throws(() => {
        webhook_1.WebhookSignature.verifyHeader(testPayload, testHeader, testSecret);
    }, { instanceOf: errors_1.WebhookSignatureError });
    t.true(error === null || error === void 0 ? void 0 : error.message.startsWith('Timestamp outside the tolerance zone'));
    const largeTolerance = Math.abs(getCurrentTimestamp() - testTimestamp) + 100;
    t.notThrows(() => webhook_1.WebhookSignature.verifyHeader(testPayload, testHeader, testSecret, largeTolerance));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViaG9vay5zcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NwZWMvd2ViaG9vay5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsOENBQXVCO0FBRXZCLDBDQUFzRDtBQUN0RCw0Q0FBa0Q7QUFFbEQsTUFBTSxjQUFjLEdBQUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7RUFxQ3JCLENBQUM7QUFDSCxNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztBQUN2RCxNQUFNLFVBQVUsR0FBRyxtQkFBbUIsQ0FBQztBQUN2QyxNQUFNLGFBQWEsR0FBRyxVQUFVLENBQUM7QUFDakMsTUFBTSxVQUFVLEdBQUcsS0FBSyxhQUFhLHNFQUFzRSxDQUFDO0FBRTVHLE1BQU0sbUJBQW1CLEdBQUcsR0FBVyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7QUFFeEUsSUFBQSxhQUFJLEVBQUMsdUZBQXVGLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtJQUNsRyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLEdBQUcsYUFBYSxDQUFDLEdBQUcsR0FBRyxDQUFDO0lBQzdFLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsMEJBQWdCLENBQUMsWUFBWSxDQUM3QyxXQUFXLEVBQ1gsVUFBVSxFQUNWLFVBQVUsRUFDVixjQUFjLENBQ2YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFBLGFBQUksRUFBQyx5RUFBeUUsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFO0lBQ3BGLE1BQU0sU0FBUyxHQUFHLEtBQUssYUFBYSxtQkFBbUIsQ0FBQztJQUN4RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENB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