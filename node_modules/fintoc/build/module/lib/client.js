import crypto from 'crypto';
import axios from 'axios';
import { JWSSignature } from './jws';
import { paginate } from './paginator';
export class Client {
    static #client;
    baseUrl;
    apiKey;
    userAgent;
    params;
    jws;
    constructor(options) {
        const { baseUrl, apiKey, userAgent, params = {}, jwsPrivateKey, } = options;
        this.baseUrl = baseUrl;
        this.apiKey = apiKey;
        this.userAgent = userAgent;
        this.params = params || {};
        if (jwsPrivateKey) {
            this.jws = new JWSSignature(jwsPrivateKey);
        }
    }
    get client() {
        if (Client.#client === undefined) {
            Client.#client = axios.create({
                baseURL: this.baseUrl,
                headers: this.staticHeaders,
                params: this.params,
            });
        }
        return Client.#client;
    }
    get staticHeaders() {
        return { Authorization: this.apiKey, 'User-Agent': this.userAgent, 'Content-Type': 'application/json' };
    }
    async request(options) {
        const { path, json, paginated = false, method = 'get', params = {}, idempotencyKey, } = options;
        const url = `${this.baseUrl}${path}`;
        const allParams = { ...this.params, ...params };
        if (paginated) {
            return paginate({
                client: this.client,
                path: url,
                headers: this.staticHeaders,
                params: allParams,
            });
        }
        const rawBody = JSON.stringify(json);
        const headers = this.buildHeaders(method, rawBody, idempotencyKey);
        const response = await this.client.request({
            method, url, params: allParams, data: rawBody, headers,
        });
        return response.data;
    }
    extend(extension) {
        const { baseUrl, apiKey, userAgent, params, } = (extension || {});
        return new Client({
            baseUrl: baseUrl || this.baseUrl,
            apiKey: apiKey || this.apiKey,
            userAgent: userAgent || this.userAgent,
            params: params ? { ...this.params, ...params } : { ...this.params },
        });
    }
    buildHeaders(method, rawBody, idempotencyKey) {
        const headers = {
            ...this.staticHeaders,
            ...this.buildJWSHeaders(method, rawBody),
        };
        if (method === 'post') {
            headers['Idempotency-Key'] = idempotencyKey || crypto.randomUUID();
        }
        return headers;
    }
    buildJWSHeaders(method, rawBody) {
        if (this.jws && (method === 'post' || method === 'put' || method === 'patch')) {
            const signature = this.jws.generateHeader(rawBody);
            return { 'Fintoc-JWS-Signature': signature };
        }
        return {};
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBRTVCLE9BQU8sS0FBd0IsTUFBTSxPQUFPLENBQUM7QUFNN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUNyQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXZDLE1BQU0sT0FBTyxNQUFNO0lBQ2pCLE1BQU0sQ0FBQyxPQUFPLENBQWlCO0lBRS9CLE9BQU8sQ0FBUztJQUNoQixNQUFNLENBQVM7SUFDZixTQUFTLENBQVM7SUFDbEIsTUFBTSxDQUFzQjtJQUM1QixHQUFHLENBQWdCO0lBRW5CLFlBQVksT0FBNEI7UUFDdEMsTUFBTSxFQUNKLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sR0FBRyxFQUFFLEVBQUUsYUFBYSxHQUN2RCxHQUFHLE9BQU8sQ0FBQztRQUNaLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLEVBQUUsQ0FBQztRQUMzQixJQUFJLGFBQWEsRUFBRSxDQUFDO1lBQ2xCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDN0MsQ0FBQztJQUNILENBQUM7SUFFRCxJQUFZLE1BQU07UUFDaEIsSUFBSSxNQUFNLENBQUMsT0FBTyxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ2pDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztnQkFDNUIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO2dCQUNyQixPQUFP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