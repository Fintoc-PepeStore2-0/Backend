import * as crypto from 'crypto';
import * as fs from 'fs';
/**
 * Class to handle JWS signature generation for Fintoc API requests.
 */
export class JWSSignature {
    privateKey;
    /**
     * Create a new JWSSignature instance with a private key.
     *
     * @param privateKey - The private key in one of these formats:
     *   - String containing PEM-formatted key
     *   - Buffer containing PEM-formatted key
     *   - String path to a PEM key file
     */
    constructor(privateKey) {
        this.privateKey = JWSSignature.loadPrivateKey(privateKey);
    }
    /**
     * Generate a JWS signature header for the given payload
     * @param rawBody - The request body as a string
     * @returns The JWS signature header to be used in 'Fintoc-JWS-Signature' header.
     */
    generateHeader(rawBody) {
        const headers = {
            alg: 'RS256',
            nonce: JWSSignature.generateNonce(),
            ts: Math.floor(Date.now() / 1000),
            crit: ['ts', 'nonce'],
        };
        const protectedBase64 = Buffer.from(JSON.stringify(headers)).toString('base64url');
        const payloadBase64 = Buffer.from(rawBody).toString('base64url');
        const signingInput = `${protectedBase64}.${payloadBase64}`;
        const signature = this.createSignature(signingInput);
        const signatureBase64 = Buffer.from(signature).toString('base64url');
        return `${protectedBase64}.${signatureBase64}`;
    }
    static loadPrivateKey(keyInput) {
        let keyMaterial;
        if (Buffer.isBuffer(keyInput)) {
            keyMaterial = keyInput;
        }
        else if (typeof keyInput === 'string') {
            if (JWSSignature.isFilePath(keyInput)) {
                try {
                    keyMaterial = fs.readFileSync(keyInput, 'utf8');
                }
                catch (error) {
                    throw new Error(`Failed to read private key file: ${keyInput}. ${error}`);
                }
            }
            else {
                keyMaterial = keyInput;
            }
        }
        else {
            throw new Error('Private key must be a string (PEM content or file path) or Buffer');
        }
        try {
            return crypto.createPrivateKey(keyMaterial);
        }
        catch (error) {
            throw new Error(`Invalid private key format: ${error}`);
        }
    }
    static isFilePath(input) {
        if (!input || typeof input !== 'string') {
            return false;
        }
        const trimmedInput = input.trim();
        if (trimmedInput.includes('-----BEGIN') && trimmedInput.includes('-----END')) {
            return false;
        }
        if (trimmedInput.includes('\n') || trimmedInput.includes('\r')) {
            return false;
        }
        if (trimmedInput.length > 1000) {
            return false;
        }
        const hasPathSeparators = trimmedInput.includes('/') || trimmedInput.includes('\\');
        const hasFileExtension = /\.[a-zA-Z0-9]{1,10}$/.test(trimmedInput);
        const looksLikeAbsolutePath = /^\/|^[a-zA-Z]:[\\\\//]|^~/.test(trimmedInput);
        return hasPathSeparators || (hasFileExtension && looksLikeAbsolutePath);
    }
    static generateNonce() {
        return crypto.randomBytes(16).toString('hex');
    }
    createSignature(data) {
        return crypto.createSign('sha256')
            .update(data)
            .sign({ key: this.privateKey, padding: crypto.constants.RSA_PKCS1_PADDING });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiandzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9qd3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDakMsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFFekI7O0dBRUc7QUFDSCxNQUFNLE9BQU8sWUFBWTtJQUNmLFVBQVUsQ0FBbUI7SUFFckM7Ozs7Ozs7T0FPRztJQUNILFlBQVksVUFBMkI7UUFDckMsSUFBSSxDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksY0FBYyxDQUFDLE9BQWU7UUFDbkMsTUFBTSxPQUFPLEdBQUc7WUFDZCxHQUFHLEVBQUUsT0FBTztZQUNaLEtBQUssRUFBRSxZQUFZLENBQUMsYUFBYSxFQUFFO1lBQ25DLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7WUFDakMsSUFBSSxFQUFFLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQztTQUN0QixDQUFDO1FBRUYsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ25GLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2pFLE1BQU0sWUFBWSxHQUFHLEdBQUcsZUFBZSxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBRTNELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDckQsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFT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