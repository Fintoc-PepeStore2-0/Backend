var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
import { resourceDelete, resourceUpdate } from '../resourceHandlers';
import { canRaiseHTTPError, getResourceClass, objetize, serialize, singularize, } from '../utils';
export class ResourceMixin {
    static mappings = {};
    static resourceIdentifier = 'id';
    #handlers;
    #methods;
    #path;
    #attributes;
    _client;
    get #originatingClass() {
        return this.constructor;
    }
    constructor(client, handlers, methods, path, content) {
        this._client = client;
        this.#handlers = handlers;
        this.#methods = methods;
        this.#path = path;
        this.#attributes = [];
        Object.entries(content).forEach(([key, value]) => {
            try {
                this[key] = value;
                this.#attributes.push(key);
            }
            catch { } /* eslint-disable-line no-empty */
        });
    }
    static async _build(client, handlers, methods, path, data) {
        const content = {};
        for (const [key, value] of Object.entries(data)) {
            /* eslint-disable no-await-in-loop */
            const rawResource = this.mappings[key] || key;
            if (value !== undefined) {
                if (Array.isArray(value)) {
                    const resource = singularize(rawResource);
                    const element = value.length > 0 ? value[0] : {};
                    const klass = await getResourceClass(resource, element);
                    content[key] = await Promise.all(value.map((x) => objetize(klass, client, x)));
                }
                else {
                    const klass = await getResourceClass(rawResource, value);
                    content[key] = await objetize(klass, client, value);
                }
            }
            /* eslint-enable no-await-in-loop */
        }
        // @ts-ignore: cannot create an instance of an abstract class
        return new this(client, handlers, methods, path, content);
    }
    _useClient() {
        return this._client;
    }
    _updateClient(newClient) {
        this._client = newClient;
    }
    serialize() {
        let serialized = {};
        this.#attributes.forEach((attribute) => {
            const element = (Array.isArray(this[attribute])
                ? this[attribute].map(serialize)
                : serialize(this[attribute]));
            serialized = { ...serialized, [attribute]: element };
        });
        return serialized;
    }
    /**
     * Update this instance of the resource.
     *
     * @param args - Data to be passed for the object to be updated with, as specified by the API
     * @returns The updated instance of the object
     */
    update(args) {
        if (!this.#methods.includes('update')) {
            throw new TypeError(`${this.#originatingClass.name}.update is not a valid function of of this resource`);
        }
        return this._update(args);
    }
    /**
     * Delete this instance of the resource.
     *
     * @param args - Object with the arguments to filter the query, using the API parameters
     * @returns The identifier of the deleted object
     */
    delete(args) {
        if (!this.#methods.includes('delete')) {
            throw new TypeError(`${this.#originatingClass.name}.delete is not a valid function of of this resource`);
        }
        return this._delete(args);
    }
    async _update(args) {
        const innerArgs = args || {};
        const id = this[this.#originatingClass.resourceIdentifier];
        let object = await resourceUpdate(this._client, this.#path, id, this.constructor, this.#handlers, this.#methods, innerArgs);
        object = await this.#handlers.update(object, id, innerArgs);
        Object.assign(this, object);
        return object;
    }
    async _delete(args) {
        const innerArgs = args || {};
        const identifier = this[this.#originatingClass.resourceIdentifier];
        await resourceDelete(this._client, this.#path, identifier, innerArgs);
        return this.#handlers.delete(identifier, innerArgs);
    }
}
__decorate([
    canRaiseHTTPError
], ResourceMixin.prototype, "_update", null);
__decorate([
    canRaiseHTTPError
], ResourceMixin.prototype, "_delete", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2VNaXhpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvbWl4aW5zL3Jlc291cmNlTWl4aW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBR0EsT0FBTyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRSxPQUFPLEVBQ0wsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxXQUFXLEdBQ3RFLE1BQU0sVUFBVSxDQUFDO0FBRWxCLE1BQU0sT0FBZ0IsYUFBYTtJQUNqQyxNQUFNLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztJQUNyQixNQUFNLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO0lBRWpDLFNBQVMsQ0FBa0M7SUFDM0MsUUFBUSxDQUFXO0lBQ25CLEtBQUssQ0FBUztJQUNkLFdBQVcsQ0FBVztJQUVaLE9BQU8sQ0FBUztJQUkxQixJQUFJLGlCQUFpQjtRQUNuQixPQUFPLElBQUksQ0FBQyxXQUFtRCxDQUFDO0lBQ2xFLENBQUM7SUFFRCxZQUNFLE1BQWMsRUFDZCxRQUF5QyxFQUN6QyxPQUFpQixFQUNqQixJQUFZLEVBQ1osT0FBNEI7UUFFNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUM7UUFDMUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFFdEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQy9DLElBQUksQ0FBQztnQkFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxD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