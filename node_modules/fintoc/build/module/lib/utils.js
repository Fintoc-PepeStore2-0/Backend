import axios from 'axios';
import * as errors from './errors';
import { GenericFintocResource } from './resources/genericFintocResource';
/**
 * Transform a string into title case.
 *
 * @param rawString - String to be transformed into a title
 * @returns Transformed title string
 */
export function toTitle(rawString) {
    return rawString[0].toUpperCase() + rawString.substr(1).toLowerCase();
}
/**
 * Transforms a snake-cased string into a pascal-cased one.
 *
 * @param snakeString - Snake-cased string to be transformed
 * @returns Pascal-cased string
 */
export function snakeToPascal(snakeString) {
    return snakeString.split('_').map(toTitle).join('');
}
/**
 * Remove the last 's' from a string if exists.
 *
 * @param rawString - String to be singularized
 * @returns The singularized string
 */
export function singularize(rawString) {
    return rawString.replace(/s$/, '');
}
/**
 * Tries to parse an ISO formatted string to check if it is parseable as a Date object.
 *
 * @param rawDate - ISO formatted string to be checked
 * @returns A boolean that represents if `rawDate` is parseable as a Date object
 */
export function isISODate(rawDate) {
    return !Number.isNaN(Date.parse(rawDate));
}
/**
 * Gets and returns the resources module interfaced as an IModule.
 *
 * @param resourceName - Pascal cased string with the name of the resource
 * @returns The resources module interfaced as an IModule
 */
export async function getResourcesModule(resourceName) {
    const camelCaseName = resourceName.charAt(0).toLowerCase() + resourceName.slice(1);
    try {
        const resources = await import(`./resources/${camelCaseName}`);
        return resources;
    }
    catch {
        return {};
    }
}
/**
 * Gets and returns the errors module interfaced as an IModule.
 *
 * @returns The errors module interfaced as an IModule
 */
export function getErrorsModule() {
    return errors;
}
/**
 * Get the class corresponding to the the resource name and value.
 *
 * @param snakeResourceName - Name of the resource in snake case
 * @param value - Value of the resource from which to get the corresponding class
 * @returns The class corresponding to the resource
 */
export async function getResourceClass(snakeResourceName, value = {}) {
    const klass = value?.constructor;
    if (klass === Object) {
        const resourceName = snakeToPascal(snakeResourceName);
        const resourcesModule = await getResourcesModule(resourceName);
        return resourcesModule[resourceName] || GenericFintocResource;
    }
    if ((klass === String) && isISODate(value)) {
        return Date;
    }
    return klass;
}
/**
 * Get the error corresponding to the error name.
 *
 * @param snakeErrorName - Name of the error in snake case
 * @returns The class corresponding to the error
 */
export function getErrorClass(snakeErrorName) {
    const errorsModule = getErrorsModule();
    const errorName = snakeToPascal(snakeErrorName);
    return errorsModule[errorName] || errorsModule.FintocError;
}
/**
 * Decorator designed for an instance method. It tries tp execute the function,
 * catches exceptions and re-rises the adequate Fintoc exception.
 *
 * @example
 * ```ts
 * class SampleClass {
 *   @canRaiseHTTPError
 *   myFunction() {
 *     console.log('This method is decorated by the function.');
 *   }
 * }
 * ```
 */
export function canRaiseHTTPError(_, __, descriptor) {
    const newDescriptor = { ...descriptor };
    newDescriptor.value = async function wrapper(...args) {
        try {
            return await descriptor.value.apply(this, args);
        }
        catch (exc) {
            if (axios.isAxiosError(exc) && exc.response) {
                const errorData = exc.response.data;
                const ErrorKlass = getErrorClass(errorData.error.type);
                throw new ErrorKlass(errorData.error);
            }
            else {
                throw exc;
            }
        }
    };
    return newDescriptor;
}
/**
 * Serializes an object.
 *
 * @param object - Object to be serialized
 * @returns The serialized object (object with only JSON-serializable fields)
 */
export function serialize(object) {
    if (typeof object?.serialize === 'function') {
        return object.serialize();
    }
    if (object?.constructor === Date) {
        return object.toISOString();
    }
    return object;
}
/**
 * Wraps some data with a class.
 *
 * @param Klass - Class that will wrap the data
 * @param client - The Client object passed to the newly created object
 * @param data - The data that the new object will contain
 * @param handlers - The post-request handlers
 * @param methods - An array of the methods that the object can execute
 * @param path - The path within the API server for the resource
 * @returns The data wrapped on the corresponding class
 */
export async function objetize(Klass, client, data, handlers = {}, methods = [], path = null) {
    if (data === null) {
        return null;
    }
    if ([String, Number, Object, Boolean].includes(Klass)) {
        return Klass(data);
    }
    if (Klass === Date) {
        return new Klass(data);
    }
    return Klass._build(client, handlers, methods, path, data);
}
/**
 * Wraps and yields some data (from a generator) with a class.
 *
 * @param generator - The generator that yields elements to be wrapped
 * @param klass - Class that will wrap the data
 * @param client - The Client object passed to the newly created objects
 * @param handlers - The post-request handlers
 * @param methods - An array of the methods that the objects can execute
 * @param path - The path within the API server for the resource
 * @returns A generator producing a sequence of data wrapped with the class
 */
export async function* objetizeGenerator(generator, klass, client, handlers = {}, methods = [], path = null) {
    for await (const element of generator) {
        yield objetize(klass, client, element, handlers, methods, path);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBcUIsTUFBTSxPQUFPLENBQUM7QUFNMUMsT0FBTyxLQUFLLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFDbkMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFMUU7Ozs7O0dBS0c7QUFDSCxNQUFNLFVBQVUsT0FBTyxDQUFDLFNBQWlCO0lBQ3ZDLE9BQU8sU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDeEUsQ0FBQztBQUVEOzs7OztHQUtHO0FBQ0gsTUFBTSxVQUFVLGFBQWEsQ0FBQyxXQUFtQjtJQUMvQyxPQUFPLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN0RCxDQUFDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxNQUFNLFVBQVUsV0FBVyxDQUFDLFNBQWlCO0lBQzNDLE9BQU8sU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDckMsQ0FBQztBQUVEOzs7OztHQUtHO0FBQ0gsTUFBTSxVQUFVLFNBQVMsQ0FBQyxPQUFlO0lBQ3ZDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztBQUM1QyxDQUFDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxNQUFNLENBQUMsS0FBSyxVQUFVLGtCQUFrQixDQUFDLFlBQW9CO0lBQzNELE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdB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