import * as crypto from 'crypto';
import { WebhookSignatureError } from './errors';
const DEFAULT_TOLERANCE_SECONDS = 300;
export class WebhookSignature {
    /**
     * Verifies the authenticity of incoming webhooks from Fintoc by validating the signature.
     *
     * @param payload - The raw request body as a string or Buffer
     * @param header - The Fintoc-Signature header value
     * @param secret - Your webhook secret key (found in your Fintoc dashboard)
     * @param tolerance - Number of seconds to tolerate when checking timestamp (default: 300)
     * @throws {WebhookSignatureError} If the signature is invalid or timestamp is outside
     * tolerance window
     */
    static verifyHeader(payload, header, secret, tolerance = DEFAULT_TOLERANCE_SECONDS) {
        if (!header) {
            throw new WebhookSignatureError('Missing Fintoc-Signature header.');
        }
        if (!secret) {
            throw new WebhookSignatureError('Webhook secret is required for verification.');
        }
        const { timestamp, signature } = WebhookSignature.parseHeader(header);
        WebhookSignature.verifyTimestamp(timestamp, tolerance);
        const expectedSignature = WebhookSignature.computeSignature(payload, timestamp, secret);
        if (!WebhookSignature.secureCompare(signature, expectedSignature)) {
            throw new WebhookSignatureError('Signature mismatch. The webhook signature is not valid.');
        }
    }
    static parseHeader(header) {
        const parts = header.split(',');
        let timestampStr;
        let signature;
        for (const part of parts) {
            const [key, value] = part.split('=');
            if (key === 't') {
                timestampStr = value;
            }
            else if (key === 'v1') {
                signature = value;
            }
        }
        if (!timestampStr || !signature) {
            throw new WebhookSignatureError('Unable to extract timestamp and signatures from header');
        }
        const timestamp = parseInt(timestampStr, 10);
        if (Number.isNaN(timestamp)) {
            throw new WebhookSignatureError('Unable to extract timestamp and signatures from header');
        }
        return { timestamp, signature };
    }
    static verifyTimestamp(timestamp, toleranceSeconds) {
        const nowSeconds = Math.floor(Date.now() / 1000);
        const timeDifference = Math.abs(nowSeconds - timestamp);
        if (timeDifference > toleranceSeconds) {
            throw new WebhookSignatureError(`Timestamp outside the tolerance zone (${timestamp})`);
        }
    }
    static computeSignature(payload, timestamp, secret) {
        const signedPayload = `${timestamp}.${payload.toString('utf8')}`;
        return crypto
            .createHmac('sha256', secret)
            .update(signedPayload)
            .digest('hex');
    }
    static secureCompare(a, b) {
        if (a.length !== b.length) {
            return false;
        }
        return crypto.timingSafeEqual(Buffer.from(a), Buffer.from(b));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViaG9vay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvd2ViaG9vay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUVqQyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFakQsTUFBTSx5QkFBeUIsR0FBRyxHQUFHLENBQUM7QUFFdEMsTUFBTSxPQUFPLGdCQUFnQjtJQUMzQjs7Ozs7Ozs7O09BU0c7SUFDSSxNQUFNLENBQUMsWUFBWSxDQUN4QixPQUF3QixFQUN4QixNQUFjLEVBQ2QsTUFBYyxFQUNkLFlBQW9CLHlCQUF5QjtRQUU3QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixNQUFNLElBQUkscUJBQXFCLENBQzdCLGtDQUFrQyxDQUNuQyxDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNaLE1BQU0sSUFBSSxxQkFBcUIsQ0FDN0IsOENBQThDLENBQy9DLENBQUM7UUFDSixDQUFDO1FBRUQsTUFBTSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFdEUsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUV2RCxNQUFNLGlCQUFpQixHQUFHLGdCQUFnQixDQUFDLGdCQUFnQixDQUN6RCxPQUFPLEVBQ1AsU0FBUyxFQUNULE1BQU0sQ0FDUCxDQUFDO1FBRUYsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsaUJBQWlCLENBQUMsRUFBRSxDQUFDO1lBQ2xFLE1BQU0sSUFBSSxxQkFBcUIsQ0FDN0IseURBQXlELENBQzFELENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUVPLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBYztRQUN2QyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLElBQUksWUFBZ0MsQ0FBQztRQUNyQyxJQUFJLFNBQTZCLENBQUM7UUFFbEMsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUN6QixNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckMsSUFBSSxHQUFHLEtBQUssR0FBRyxFQUFFLENBQUM7Z0JBQ2hCLFlBQVksR0FBRyxLQUFLLENBQUM7WUFDdkIsQ0FBQztpQkFBTSxJQUFJLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztnQkFDeEIsU0FBUyxHQUFHLEtBQUssQ0FBQztZQUNwQixDQUFDO1FBQ0gsQ0FBQztRQUVELElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNoQyxNQUFNLElBQUkscUJBQXFCLENBQzdCLHdEQUF3RCxDQUN6RCxDQUFDO1FBQ0osQ0FBQztRQUVELE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDN0MsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDNUIsTUFBTSxJQUFJLHFCQUFxQixDQUM3Qix3REFBd0QsQ0FDekQsQ0FBQztRQUNKLENBQUM7UUFFRCxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFTyxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQWlCLEVBQUUsZ0JBQXdCO1FBQ3hFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ2pELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQyxDQUFDO1FBRXhELElBQUksY0FBYyxHQUFHLGdCQUFnQixFQUFFLENBQUM7WUFDdEMsTUFBTSxJQUFJLHFCQUFxQixDQUM3Qix5Q0FBeUMsU0FBUyxHQUFHLENBQ3RELENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUVPLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FDN0IsT0FBd0IsRUFDeEIsU0FBaUIsRUFDakIsTUFBYztRQUVkLE1BQU0sYUFBYSxHQUFHLEdBQUcsU0FBUyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUNqRSxPQUFPLE1BQU07YUFDVixVQUFVLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQzthQUM1QixNQUFNLENBQUMsYUFBYSxDQUFDO2FBQ3JCLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRU8sTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFTLEVBQUUsQ0FBUztRQUMvQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzFCLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUNELE9BQU8sTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRSxDQUFDO0NBQ0YifQ==